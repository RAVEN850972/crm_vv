# Календарь монтажей и оптимизация маршрутов

## Обзор функциональности

Модуль календаря добавляет в CRM-систему следующие возможности:

### 1. Автоматическое создание транзакций
- При завершении заказа (статус "completed") автоматически создается доходная транзакция на сумму заказа
- Создается расходная транзакция на себестоимость услуг
- Предотвращает дублирование транзакций

### 2. Календарь монтажей
- Планирование монтажных работ с привязкой к заказам
- Назначение монтажников на конкретные время и дату
- Отслеживание статусов: запланировано, выполняется, завершено, отменено, перенесено
- Система приоритетов: низкий, обычный, высокий, срочный
- Контроль просрочек и уведомления

### 3. Оптимизация маршрутов
- Автоматический расчет оптимального порядка объектов для монтажников
- Геокодирование адресов клиентов
- Расчет расстояний и времени в пути
- Учет приоритетов заказов при планировании

## API Endpoints

### Календарь
- `GET /api/calendar/` - получение календаря на период
- `POST /api/calendar/` - создание нового расписания
- `GET /api/calendar/schedule/{id}/` - детали расписания
- `PUT /api/calendar/schedule/{id}/` - обновление расписания
- `DELETE /api/calendar/schedule/{id}/` - удаление расписания

### Управление работами
- `POST /api/calendar/schedule/{id}/start/` - начало работы
- `POST /api/calendar/schedule/{id}/complete/` - завершение работы

### Маршрутизация
- `GET /api/calendar/routes/` - получение маршрута
- `POST /api/calendar/routes/optimize/` - оптимизация маршрута
- `GET /api/calendar/installer/{id}/schedule/` - расписание монтажника

### Проверка доступности
- `POST /api/calendar/availability/check/` - проверка доступности монтажников

## Использование

### Создание расписания монтажа

```python
from calendar_app.services import CalendarService
from datetime import date, time, timedelta

schedule = CalendarService.create_schedule(
    order=order,
    scheduled_date=date(2025, 6, 1),
    start_time=time(9, 0),
    end_time=time(12, 0),
    installers_ids=[1, 2],
    priority='high',
    estimated_duration=timedelta(hours=3)
)
```

### Оптимизация маршрута

```python
from calendar_app.services import RouteOptimizationService

route = RouteOptimizationService.optimize_daily_route(
    installer_id=1,
    date=date(2025, 6, 1)
)
```

### Проверка доступности монтажников

```python
conflicts = CalendarService.check_installer_availability(
    installer_ids=[1, 2],
    date=date(2025, 6, 1),
    start_time=time(9, 0),
    end_time=time(12, 0)
)
```

## Команды управления

### Автоматическое создание расписаний
```bash
# Создать расписания для всех заказов без расписания
python manage.py create_schedules

# Создать расписания начиная с определенной даты
python manage.py create_schedules --start-date 2025-06-01

# Автоматически назначать монтажников
python manage.py create_schedules --auto-assign

# Показать план без создания
python manage.py create_schedules --dry-run
```

### Оптимизация маршрутов
```bash
# Оптимизировать маршруты на завтра
python manage.py optimize_routes

# Оптимизировать на конкретную дату
python manage.py optimize_routes --date 2025-06-01

# Оптимизировать для конкретного монтажника
python manage.py optimize_routes --installer 1

# Оптимизировать на несколько дней вперед
python manage.py optimize_routes --days-ahead 7
```

## Модели данных

### InstallationSchedule
- `order` - связанный заказ
- `scheduled_date` - дата монтажа
- `scheduled_time_start/end` - время начала/окончания
- `installers` - назначенные монтажники
- `status` - статус выполнения
- `priority` - приоритет
- `actual_start_time/end_time` - фактическое время выполнения
- `latitude/longitude` - координаты для маршрутизации

### RouteOptimization
- `installer` - монтажник
- `date` - дата маршрута
- `total_distance` - общее расстояние
- `total_travel_time` - общее время в пути
- `is_optimized` - флаг оптимизации

### RoutePoint
- `route` - маршрут
- `schedule` - расписание монтажа
- `sequence_number` - порядковый номер в маршруте
- `arrival_time/departure_time` - время прибытия/отъезда

## Настройки

В `settings.py` можно настроить параметры календаря:

```python
CALENDAR_SETTINGS = {
    'DEFAULT_WORK_START_TIME': '08:00',
    'DEFAULT_WORK_END_TIME': '18:00',
    'DEFAULT_INSTALLATION_DURATION': 2,  # часы
    'MAX_INSTALLATIONS_PER_DAY': 5,
    'WAREHOUSE_ADDRESS': 'Москва, ул. Складская, 1',
}

# API ключ для геокодирования (опционально)
YANDEX_MAPS_API_KEY = 'ваш_ключ_api'
```

## Права доступа

- **Владелец**: полный доступ ко всем функциям
- **Менеджер**: может создавать и редактировать расписания для своих заказов
- **Монтажник**: может просматривать свое расписание и отмечать начало/завершение работ

## Интеграция с существующими модулями

### Автоматические транзакции
При завершении заказа автоматически создаются:
1. Доходная транзакция на сумму заказа
2. Расходная транзакция на себестоимость

### Связь с заказами
Каждое расписание привязано к конкретному заказу и автоматически обновляет его статус при начале/завершении работ.

### Уведомления
Система отслеживает просрочки и может отправлять уведомления (требует дополнительной настройки).

## Планы развития

1. **Уведомления**: SMS/Email уведомления клиентам и монтажникам
2. **Мобильное приложение**: для монтажников с GPS-трекингом
3. **Интеграция с картами**: визуализация маршрутов на карте
4. **Прогнозирование**: ML-алгоритмы для оптимального планирования
5. **Склад**: интеграция с управлением материалами
6. **Фото-отчеты**: загрузка фотографий до/после монтажа

## Troubleshooting

### Проблемы с геокодированием
- Убедитесь, что указан корректный API ключ Яндекс.Карт
- Проверьте правильность адресов клиентов
- В случае отсутствия ключа используется заглушка с примерными координатами

### Ошибки оптимизации
- Проверьте наличие координат у расписаний
- Убедитесь, что у заказов указаны корректные адреса
- Проверьте статусы расписаний (должны быть 'scheduled')

### Конфликты расписания
- Система автоматически проверяет пересечения по времени
- При создании расписания через API проверяйте доступность монтажников